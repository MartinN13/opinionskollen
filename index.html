<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Opinionskollen</title>
<link rel="stylesheet" href="css/sierra.min.css">
<link rel="stylesheet" href="css/style.css">
<script src="js/mithril.min.js"></script>
<script src="js/MSXTransformer.js"></script>
<script src="js/jquery-2.2.3.min.js"></script>
<script src="js/main.js"></script>
</head>
<body>

<div class="nav">
  <li><a href="#/">Översikt</a></li>
  <li><a href="#/partier">Enskilda partier</a></li>
  <li><a href="#/forandring">Översikt förändring</a></li>
  <li><a href="#/partierforandring">Enskilda partier förändring</a></li>
</div>

<div class="container navbar">
  <div class="aligner-space-between">
    <h1 class="text-big">Opinionskollen</h1>
    <button id="hamburger" class="hamburger hamburger--elastic" type="button">
      <span class="hamburger-box">
        <span class="hamburger-inner"></span>
      </span>
    </button>
  </div>
</div>

<div id="main"></div>

<script type="text/msx;harmony=true">
/* components */
var Overview = {
  data: m.prop(),
  selected: m.prop(),
  selectedValue: 0,
  mostRecentValue: 0,

  /* request json data and select latest data period */
  init() {
    m.request({method: "GET", url: "json/data.json"}).then(this.data).then(function() {
      Overview.selected = Overview.data().data[Overview.data().data.length - 1].key[1];
      Overview.selectedValue = Overview.data().data.length - 1;
      Overview.mostRecentValue = Overview.data().data.length - 1;
    });
  },
  controller() {
    Overview.init();

    /* save selected period as string, values and heights for selected period in arrays */
    this.list = function() {
      var values = [],
          heights = [],
          year = "",
          period = "",
          selected = "",
          months = ["Januari", "Februari", "Mars", "April", "Maj", "Juni", "Juli", "Augusti",
                    "September", "Oktober", "November", "December"];

      for (var i = 0; i < Overview.data().data.length; i++) {
        if (Overview.data().data[i].key[1] == Overview.selected) {
          values.push(Overview.data().data[i]);
          heights.push(Overview.data().data[i].values * 2 + "%");
        }
      };

      year = Overview.selected.substring(0,4);
      period = Overview.selected.substring(5, 7);

      if (period >= 10) {
        period = months[period - 1];
      } else {
        period = Overview.selected.substring(6, 7);
        period = months[period - 1];
      };

      selected = period + " " + year;

      return [values, heights, selected];
    };

    /* select previous period */
    this.previous = function() {
      if (Overview.selectedValue == 0) {
        /* user is on first period */
      } else {
        Overview.selectedValue--;
        Overview.selected = Overview.data().data[Overview.selectedValue].key[1];
      };
    };

    /* select next period */
    this.next = function() {
      if (Overview.selectedValue == Overview.mostRecentValue) {
        /* user is on last period */
      } else {
        Overview.selectedValue++;
        Overview.selected = Overview.data().data[Overview.selectedValue].key[1];
      };
    };
  },
  view(ctrl) {
    /* animate graphs when view is finished loading */
    this.animate = function(element, init) {
      /* resize graph */
      function graphSize() {
        var navHeight = $(".navbar").height();
        var windowHeight = $(window).height();

        $(".overview").css("height", windowHeight).css("height", "-=" + navHeight + "px");

        setTimeout(function() {
          $(".graph").css("height", "initial");
          $(".graph").css("height", $(".graph").height() + "px");
        }, 100);
      }

      if (!init) {
        graphSize();
      }

      /* viewheight is broken on Android so disable it and only resize on orientation change */
      if (/Android/i.test(navigator.userAgent)) {
        var androidWidth = $(window).width();

        $(window).resize(function() {
          if (androidWidth != $(window).width()) {
            graphSize();
            androidWidth = $(window).width();
          }
        });
      } else {
        /* resize graph on window resize */
        $(window).resize(function() {
          graphSize();
        });
      }

      $("#v").animate({"height": ctrl.list()[1][5]});
      $("#s").animate({"height": ctrl.list()[1][4]});

      if (ctrl.list()[1][6] == "NaN%") {
        $("#mp").animate({"height": "1px"});
      } else {
        $("#mp").animate({"height": ctrl.list()[1][6]});
      };

      $("#c").animate({"height": ctrl.list()[1][0]});
      $("#l").animate({"height": ctrl.list()[1][1]});
      $("#m").animate({"height": ctrl.list()[1][2]});

      if (ctrl.list()[1][3] == "NaN%") {
        $("#kd").animate({"height": "1px"});
      } else {
        $("#kd").animate({"height": ctrl.list()[1][3]});
      };

      if (ctrl.list()[1][7] == "NaN%") {
        $("#sd").animate({"height": "1px"});
      } else {
        $("#sd").animate({"height": ctrl.list()[1][7]});
      };
    };

    return <div class="overview" config={this.animate}>
      <div class="container graph-menu">
      <h1 class="text-medium text-gray previous" onclick={ctrl.previous}>Före</h1>
      <h1 class="text-medium text-gray period">{ctrl.list()[2]}</h1>
      <h1 class="text-medium text-gray next" onclick={ctrl.next}>Efter</h1>
      </div>
      <div class="container graph">
        <div id="v" class="party">
          <p class="text-center">{ctrl.list()[0][5].values}%</p>
          <div class="v"></div>
        </div>
        <div id="s" class="party">
          <p class="text-center">{ctrl.list()[0][4].values}%</p>
          <div class="s"></div>
        </div>        
        <div id="mp" class="party">
          <p class="text-center">{ctrl.list()[0][6].values}%</p>
          <div class="mp"></div>
        </div>
        <div id="c" class="party">
          <p class="text-center">{ctrl.list()[0][0].values}%</p>
          <div class="c"></div>
        </div>
        <div id="l" class="party">
          <p class="text-center">{ctrl.list()[0][1].values}%</p>
          <div class="l"></div>
        </div>
        <div id="m" class="party">
          <p class="text-center">{ctrl.list()[0][2].values}%</p>
          <div class="m"></div>
        </div>
        <div id="kd" class="party">
          <p class="text-center">{ctrl.list()[0][3].values}%</p>
          <div class="kd"></div>
        </div>
        <div id="sd" class="party no-margin-right">
          <p class="text-center">{ctrl.list()[0][7].values}%</p>
          <div class="sd"></div>
        </div>
      </div>
      <div class="container background-dark logos">
        <img src="img/logo-v.png" alt="Vänsterpartiet" class="v-img" />
        <img src="img/logo-s.svg" alt="Socialdemokraterna" class="s-img" />
        <img src="img/logo-mp.svg" alt="Miljöpartiet" class="mp-img" />
        <img src="img/logo-c.svg" alt="Centerpartiet" class="c-img" />
        <img src="img/logo-l.png" alt="Liberalerna" class="l-img" />
        <img src="img/logo-m.png" alt="Moderaterna" class="m-img" />
        <img src="img/logo-kd.svg" alt="Kristdemokraterna" class="kd-img" />
        <img src="img/logo-sd.png" alt="Sverigedemokraterna" class="sd-img no-margin-right" />
      </div>
    </div>
  }
}

m.route(document.getElementById("main"), "/", {
    "/": Overview,
});
m.route.mode = "hash";

</script>

<footer class="background-dark">
  <div class="container">
    <div class="section text-center text-small">
      <h1 class="text-big text-with-subtitle">Opinionskollen</h1>
      <p class="text-gray">v1.0.0</p>
      <p>
        <a href="#">GitHub</a>
        &nbsp;&nbsp;|&nbsp;&nbsp;
        <a href="#">Second link</a>
        &nbsp;&nbsp;|&nbsp;&nbsp; 
        <a href="#">Third link</a>
      </p>
    </div>
  </div>
</footer>
</body>
</html>
