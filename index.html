<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Opinionskollen</title>
<link rel="stylesheet" href="css/sierra.min.css">
<link rel="stylesheet" href="css/style.css">
<script src="js/mithril.min.js"></script>
<script src="js/MSXTransformer.js"></script>
<script src="js/jquery-2.2.3.min.js"></script>
<script src="js/main.js"></script>
</head>
<body>

<div class="nav">
  <li><a class="navlink" href="#/">Översikt</a></li>
  <li><a class="navlink" href="#/partier">Enskilda partier</a></li>
  <li><a class="navlink" href="#/forandring">Översikt förändring</a></li>
  <li><a class="navlink" href="#/partierforandring">Enskilda partier förändring</a></li>
</div>

<div class="container navbar">
  <div class="aligner-space-between">
    <h1 class="text-big">Opinionskollen</h1>
    <button id="hamburger" class="hamburger hamburger--elastic" type="button">
      <span class="hamburger-box">
        <span class="hamburger-inner"></span>
      </span>
    </button>
  </div>
</div>

<div id="main"></div>

<script type="text/msx;harmony=true">
/* components */
var Overview = {
  data: m.prop(),
  selected: m.prop(),
  selectedValue: 0,
  mostRecentValue: 0,

  /* request json data and select latest data period */
  init() {
    m.request({method: "GET", url: "json/data.json"}).then(this.data).then(function() {
      Overview.selected = Overview.data().data[Overview.data().data.length - 1].key[1];
      Overview.selectedValue = Overview.data().data.length - 1;
      Overview.mostRecentValue = Overview.data().data.length - 1;
    });
  },
  controller() {
    Overview.init();

    /* save selected period as string, values and heights for selected period in arrays */
    this.list = function() {
      var values = [],
          heights = [],
          year = "",
          period = "",
          selected = "",
          months = ["Januari", "Februari", "Mars", "April", "Maj", "Juni", "Juli", "Augusti",
                    "September", "Oktober", "November", "December"];

      for (var i = 0; i < Overview.data().data.length; i++) {
        if (Overview.data().data[i].key[1] == Overview.selected) {
          if (Overview.data().data[i].values == "..") {
            values.push("0.0");
            heights.push(0.0);
          } else {
            values.push(Overview.data().data[i].values);
            heights.push(Overview.data().data[i].values);
          }
        }
      };

      year = Overview.selected.substring(0,4);
      period = Overview.selected.substring(5, 7);

      if (period >= 10) {
        period = months[period - 1];
      } else {
        period = Overview.selected.substring(6, 7);
        period = months[period - 1];
      };

      selected = period + " " + year;

      return [values, heights, selected];
    };

    /* select previous period */
    this.previous = function() {
      if (Overview.selectedValue == 0) {
        /* user is on first period */
      } else {
        Overview.selectedValue--;
        Overview.selected = Overview.data().data[Overview.selectedValue].key[1];
      };
    };

    /* select next period */
    this.next = function() {
      if (Overview.selectedValue == Overview.mostRecentValue) {
        /* user is on last period */
      } else {
        Overview.selectedValue++;
        Overview.selected = Overview.data().data[Overview.selectedValue].key[1];
      };
    };
  },
  view(ctrl) {
    /* resize graph and animate bars when view is finished loading */
    this.animate = function(element, init) {
      /* resize graph */
      function graphSize() {
        var navHeight = $(".navbar").height();
        var windowHeight = $(window).height();

        $(".overview").css("height", windowHeight).css("height", "-=" + navHeight + "px");

        setTimeout(function() {
          $(".graph").css("height", "initial");
          $(".graph").css("height", $(".graph").height() + "px");
        }, 100);
      }

      /* resize graph once on first load */
      if (!init) {
        graphSize();
      }

      /* viewheight is broken on Chrome for android so only resize on orientation change */
      if (/Android/i.test(navigator.userAgent)) {
        var androidWidth = $(window).width();

        $(window).resize(function() {
          if (androidWidth != $(window).width()) {
            graphSize();
            androidWidth = $(window).width();
          }
        });
      } else {
        /* if not android resize graph on window resize */
        $(window).resize(function() {
          graphSize();
        });
      }

      /* calculate bar heights */
      var maxHeight = Math.max.apply(Math, ctrl.list()[1]),
          vHeight = ((ctrl.list()[1][5] / maxHeight) * 100) + "%",
          sHeight = ((ctrl.list()[1][4] / maxHeight) * 100) + "%",
          mpHeight = ((ctrl.list()[1][6] / maxHeight) * 100) + "%",
          cHeight = ((ctrl.list()[1][0] / maxHeight) * 100) + "%",
          lHeight = ((ctrl.list()[1][1] / maxHeight) * 100) + "%",
          mHeight = ((ctrl.list()[1][2] / maxHeight) * 100) + "%",
          kdHeight = ((ctrl.list()[1][3] / maxHeight) * 100) + "%",
          sdHeight = ((ctrl.list()[1][7] / maxHeight) * 100) + "%";

      /* animate bar heights */
      $("#v").animate({"height": vHeight});
      $("#s").animate({"height": sHeight});

      if (mpHeight == "0%") {
        $("#mp").animate({"height": "23px"});
      } else {
        $("#mp").animate({"height": mpHeight});
      };

      $("#c").animate({"height": cHeight});
      $("#l").animate({"height": lHeight});
      $("#m").animate({"height": mHeight});

      if (kdHeight == "0%") {
        $("#kd").animate({"height": "23px"});
      } else {
        $("#kd").animate({"height": kdHeight});
      };

      if (sdHeight == "0%") {
        $("#sd").animate({"height": "23px"});
      } else {
        $("#sd").animate({"height": sdHeight});
      };
    };

    return <div class="overview" config={this.animate}>
      <div class="container graph-menu">
      <h1 class="text-medium text-gray previous" onclick={ctrl.previous}>Före</h1>
      <h1 class="text-medium text-gray period">{ctrl.list()[2]}</h1>
      <h1 class="text-medium text-gray next" onclick={ctrl.next}>Efter</h1>
      </div>
      <div class="container graph">
        <div id="v" class="parties">
          <p class="text-center">{ctrl.list()[0][5]}%</p>
          <div class="v"></div>
        </div>
        <div id="s" class="parties">
          <p class="text-center">{ctrl.list()[0][4]}%</p>
          <div class="s"></div>
        </div>        
        <div id="mp" class="parties">
          <p class="text-center">{ctrl.list()[0][6]}%</p>
          <div class="mp"></div>
        </div>
        <div id="c" class="parties">
          <p class="text-center">{ctrl.list()[0][0]}%</p>
          <div class="c"></div>
        </div>
        <div id="l" class="parties">
          <p class="text-center">{ctrl.list()[0][1]}%</p>
          <div class="l"></div>
        </div>
        <div id="m" class="parties">
          <p class="text-center">{ctrl.list()[0][2]}%</p>
          <div class="m"></div>
        </div>
        <div id="kd" class="parties">
          <p class="text-center">{ctrl.list()[0][3]}%</p>
          <div class="kd"></div>
        </div>
        <div id="sd" class="parties no-margin-right">
          <p class="text-center">{ctrl.list()[0][7]}%</p>
          <div class="sd"></div>
        </div>
      </div>
      <div class="container background-dark logos">
        <img src="img/logo-v.png" alt="Vänsterpartiet" class="v-img" />
        <img src="img/logo-s.svg" alt="Socialdemokraterna" class="s-img" />
        <img src="img/logo-mp.svg" alt="Miljöpartiet" class="mp-img" />
        <img src="img/logo-c.svg" alt="Centerpartiet" class="c-img" />
        <img src="img/logo-l.png" alt="Liberalerna" class="l-img" />
        <img src="img/logo-m.png" alt="Moderaterna" class="m-img" />
        <img src="img/logo-kd.svg" alt="Kristdemokraterna" class="kd-img" />
        <img src="img/logo-sd.png" alt="Sverigedemokraterna" class="sd-img no-margin-right" />
      </div>
    </div>
  }
}

var Party = {
  data: m.prop(),
  selected: m.prop(),
  parties: ["v", "s", "mp", "c", "l", "m", "kd", "sd"],

  /* request json data and select default party */
  init() {
    m.request({method: "GET", url: "json/data.json"}).then(this.data).then(function() {
      Party.selected = Party.parties[0];
    });
  },
  controller() {
    Party.init();

    /* save all periods as string, save values and widths for selected party in arrays */
    this.list = function() {
      var periods = [],
          periodsSorted = [],
          widths = [],
          year = "",
          period = "",
          months = ["Januari", "Februari", "Mars", "April", "Maj", "Juni", "Juli", "Augusti",
                    "September", "Oktober", "November", "December"];

      for (var i = Party.data().data.length - 1; i > 0; i--) {
        if (Party.data().data[i].key[0] == Party.selected) {
            periods.push(Party.data().data[i].key[1]);
            widths.push(Party.data().data[i].values);
          }
      };

      for (var i = 0; i < periods.length; i++) {
        year = periods[i].substring(0,4);
        period = periods[i].substring(5, 7);

        if (period >= 10) {
          period = months[period - 1];
        } else {
          period = periods[i].substring(6, 7);
          period = months[period - 1];
        };

        period = period + " " + year;
        periodsSorted.push(period);
      };
      console.log(periodsSorted);
      console.log(widths);
      return [periodsSorted, widths];
    };

    /* select previous party */
    this.previous = function() {

    };

    /* select next party */
    this.next = function() {

    };
  },
  view(ctrl) {
    /* animate bars when view is finished loading */
    this.animate = function(element, init) {
      /* resize graph */

      /* resize graph on first load */

      /* resize on orientation change */

      /* calculate bar widths */

      /* animate bars */
    };

    return <div class="party" config={this.animate}>
      <div class="container graph-menu">
      <h1 class="text-medium text-gray previous" onclick={ctrl.previous}>Framåt</h1>
      <h1 class="text-medium text-gray party-name">{Party.selected}</h1>
      <h1 class="text-medium text-gray next" onclick={ctrl.next}>Bakåt</h1>
      </div>
      <div class="container party-graph">
        <div class="party-entry">
          <p class="party-period">{ctrl.list()[0][0]}</p>
          <div class="v party-bar"></div>
          <p class="party-value">{ctrl.list()[1][0]}</p>
        </div>
      </div>
    </div>
  }
}
m.route(document.getElementById("main"), "/", {
    "/": Overview,
    "/partier": Party,
});
m.route.mode = "hash";

</script>

<footer class="background-dark">
  <div class="container">
    <div class="section text-center text-small">
      <h1 class="text-big text-with-subtitle">Opinionskollen</h1>
      <p class="text-gray">v1.0.0</p>
      <p>
        <a href="#">GitHub</a>
        &nbsp;&nbsp;|&nbsp;&nbsp;
        <a href="#">Second link</a>
        &nbsp;&nbsp;|&nbsp;&nbsp; 
        <a href="#">Third link</a>
      </p>
    </div>
  </div>
</footer>
</body>
</html>
